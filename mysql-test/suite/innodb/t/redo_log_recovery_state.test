--source include/have_debug.inc

CREATE TABLE foo (c1 INT PRIMARY KEY, c2 BLOB) ENGINE=INNODB;

--let MYSQLD_DATADIR =`SELECT @@datadir`

--echo #
--echo # Stop the page cleaner and other background threads
--echo #
--source ../include/stop_dirty_page_flushing_and_background_redo_producers.inc

--echo #
--echo # Do DML such that redo log record spans multiple log blocks
--echo #
INSERT INTO foo VALUES(1, repeat('#',16000));

--echo #
--echo # Take snapshot of the datadir to MYSQL_TMP_DIR/datadir_snapshot
--echo #
--mkdir $MYSQL_TMP_DIR/datadir_snapshot
--force-cpdir $MYSQLD_DATADIR $MYSQL_TMP_DIR/datadir_snapshot

--echo #
--echo # Resume the page cleaner and other background threads
--echo #
--source ../include/resume_dirty_page_flushing_and_background_redo_producers.inc

--echo #
--echo # Clean server shutdown
--echo #
--source include/shutdown_mysqld.inc

--echo # Take snapshot of datadir after shutdown to MYSQL_TMP_DIR/datadir_with_shutdown
--mkdir $MYSQL_TMP_DIR/datadir_with_shutdown
--force-cpdir $MYSQLD_DATADIR $MYSQL_TMP_DIR/datadir_with_shutdown

--echo #
--echo # Start the server with the snapshot dir to recover it
--echo #
--let DATADIR = $MYSQL_TMP_DIR/datadir_snapshot/data
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
--let $restart_parameters = restart: --datadir=$DATADIR
--source include/start_mysqld.inc

--echo #
--echo # Clean server shutdown
--echo #
--source include/shutdown_mysqld.inc

--echo #
--echo # Compare the recovered file and the one with clean shutdown
--echo #
--diff_files $MYSQL_TMP_DIR/datadir_with_shutdown/data/test/foo.ibd $MYSQL_TMP_DIR/datadir_snapshot/data/test/foo.ibd

--echo #
--echo # Cleanup
--echo #
--let $restart_parameters = restart: --datadir=$MYSQLD_DATADIR
--replace_result $MYSQLD_DATADIR MYSQLD_DATADIR
--source include/start_mysqld.inc
DROP TABLE foo;
--force-rmdir $MYSQL_TMP_DIR/datadir_snapshot
--force-rmdir $MYSQL_TMP_DIR/datadir_with_shutdown
